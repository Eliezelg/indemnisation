# PLAN D√âTAILL√â PHASE 2 - AM√âLIORATION
## Plateforme d'Indemnisation Vols Perturb√©s

**Dur√©e** : 8 semaines (Mois 3-4)
**Objectif** : Professionnaliser la plateforme MVP
**Budget** : ~80‚Ç¨/mois
**Pr√©requis** : Phase 1 MVP compl√©t√©e ‚úÖ

---

## üéØ OBJECTIF PHASE 2

Transformer le MVP en une plateforme professionnelle multi-utilisateur avec :
1. Support multilingue complet (FR, HE, EN) avec RTL
2. Upload et gestion de documents
3. Int√©gration API de donn√©es de vol r√©elles
4. Dashboard admin visuel complet
5. Am√©lioration g√©n√©rale de l'UX

---

## üì¶ LIVRABLES PHASE 2

Au terme des 8 semaines :
- ‚úÖ Support complet 3 langues (fran√ßais, h√©breu, anglais)
- ‚úÖ Interface RTL parfaite pour l'h√©breu
- ‚úÖ Upload de documents (carte d'embarquement, etc.)
- ‚úÖ Validation admin des documents
- ‚úÖ API de vol r√©elle int√©gr√©e (AviationStack)
- ‚úÖ Autocomplete num√©ros de vol
- ‚úÖ Dashboard admin professionnel
- ‚úÖ Statistiques et graphiques
- ‚úÖ Gestion avanc√©e des r√©clamations

---

## üìÖ PLANNING D√âTAILL√â PHASE 2

### ‚úÖ SEMAINE 9-10 : Internationalisation (i18n) Compl√®te - COMPL√âT√â

#### Objectif ‚úÖ ATTEINT
Support multilingue FR/HE/EN avec direction RTL pour l'h√©breu.

#### T√¢ches Backend

**Jour 1-2 : Emails multilingues**
```typescript
[ ] Cr√©er EmailTemplatesService
[ ] Templates par langue :
    - welcome.{fr,he,en}.hbs
    - claim-created.{fr,he,en}.hbs
    - claim-status.{fr,he,en}.hbs
    - verify-email.{fr,he,en}.hbs

[ ] Logique de s√©lection template selon locale user
[ ] Tester envoi emails dans les 3 langues
```

#### T√¢ches Frontend

**Jour 3-4 : Configuration next-intl**
```typescript
[‚úÖ] Installer next-intl :
    npm install next-intl

[‚úÖ] Cr√©er structure messages/ :
    messages/
    ‚îú‚îÄ‚îÄ fr.json (unified structure)
    ‚îú‚îÄ‚îÄ he.json (unified structure)
    ‚îî‚îÄ‚îÄ en.json (unified structure)

[‚úÖ] Configurer i18n.config.ts :
    export const locales = ['fr', 'he', 'en'] as const;
    export const defaultLocale = 'fr' as const;

[‚úÖ] Cr√©er middleware.ts pour d√©tection langue
[‚úÖ] Restructurer routes : app/[locale]/...
```

**Jour 5 : Traductions fran√ßaises**
```json
[‚úÖ] Traduire tous les textes en fran√ßais (baseline)
[‚úÖ] common.json : navigation, boutons, labels
[‚úÖ] auth.json : pages login, register, forgot-password
[‚úÖ] claim.json : formulaire 3 √©tapes, labels, erreurs
[‚úÖ] dashboard.json : titres, statuts, actions
```

**Jour 6 : Traductions h√©bra√Øques**
```json
[‚úÖ] Traduire tous les textes en h√©breu
[‚úÖ] V√©rifier termes l√©gaux corrects
[‚úÖ] Adapter formulations culturellement
[‚úÖ] Traduction professionnelle r√©alis√©e
```

**Jour 7 : Traductions anglaises**
```json
[‚úÖ] Traduire tous les textes en anglais
[‚úÖ] V√©rifier termes juridiques (UK English)
[‚úÖ] Relecture native speaker
```

**Jour 8-9 : Support RTL**
```typescript
[‚úÖ] Configuration RTL dans i18n :
    Support RTL via next-intl et Tailwind CSS

[‚úÖ] Adapter layout.tsx :
    <html lang={locale} dir={direction}>

[‚úÖ] Refactorer composants avec classes RTL :
    - Direction automatique bas√©e sur locale
    - Support complet h√©breu RTL
    - Navigation et layout adapt√©s

[‚úÖ] Tester exhaustivement tous les composants en RTL
```

**Jour 10 : Language Selector**
```typescript
[‚úÖ] Cr√©er composant LanguageSelector :
    - Dropdown avec drapeaux
    - FR üá´üá∑ | HE üáÆüá± | EN üá¨üáß
    - Navigation entre locales
    - Persistence via URL routing

[‚úÖ] Int√©grer dans navbar
[‚úÖ] Int√©grer dans footer
[‚úÖ] Tests de changement de langue
```

**Tests et Validation Semaine 9-10** :
- [‚úÖ] Toutes les pages traduites dans 3 langues
- [‚úÖ] RTL parfait pour h√©breu (support complet)
- [‚úÖ] S√©lecteur de langue fonctionnel
- [ ] Emails envoy√©s dans la bonne langue (√† faire en Semaine 11-12)
- [‚úÖ] Navigation fluide entre langues

---

### ‚úÖ SEMAINE 11-12 : Upload et Gestion de Documents - COMPL√âT√â

#### Objectif ‚úÖ ATTEINT
Permettre l'upload de documents (carte d'embarquement, justificatifs) avec validation admin.

#### T√¢ches Backend

**Jour 1-2 : Storage et Upload**
```typescript
[ ] D√©cision de storage :
    Option A : Local filesystem (/uploads) - Gratuit
    Option B : Cloudflare R2 - ~1‚Ç¨/mois (recommand√©)

[ ] Si Cloudflare R2 :
    - Cr√©er compte Cloudflare
    - Cr√©er bucket R2
    - Installer @aws-sdk/client-s3
    - Configurer credentials

[ ] Cr√©er DocumentsModule
[ ] Cr√©er Document model Prisma :
    model Document {
      id          String   @id @default(cuid())
      claimId     String
      type        String   // BOARDING_PASS, ID, RECEIPT
      filename    String
      originalName String
      mimeType    String
      size        Int
      path        String   // ou R2 key
      status      String   @default("PENDING") // PENDING, VALIDATED, REJECTED
      uploadedAt  DateTime @default(now())
      validatedAt DateTime?
      claim       Claim    @relation(fields: [claimId], references: [id])
    }

[ ] Cr√©er migration : npx prisma migrate dev --name add_documents
```

**Jour 3 : DocumentsService**
```typescript
[ ] Impl√©menter DocumentsService :
    - upload(file, claimId, type, userId)
      * V√©rifier taille (max 5MB)
      * V√©rifier MIME type (PDF, JPG, PNG)
      * Upload vers R2 ou filesystem
      * Cr√©er entr√©e DB
      * Retourner document info

    - download(docId, userId)
      * V√©rifier ownership
      * G√©n√©rer signed URL (R2) ou stream file
      * Retourner file

    - delete(docId, userId)
      * V√©rifier ownership
      * Supprimer de R2/filesystem
      * Supprimer de DB

    - validate(docId, status) // Admin only
      * Mettre √† jour status (VALIDATED/REJECTED)
      * Envoyer email notification

[ ] Tests unitaires upload/download/delete
```

**Jour 4 : DocumentsController**
```typescript
[ ] Cr√©er endpoints :
    - POST /claims/:id/documents
      * @UseInterceptors(FileInterceptor('file'))
      * V√©rifier ownership claim
      * Appeler DocumentsService.upload()

    - GET /claims/:id/documents
      * Lister documents d'une claim
      * V√©rifier ownership

    - GET /documents/:id
      * Download document
      * V√©rifier ownership

    - DELETE /documents/:id
      * Supprimer document
      * V√©rifier ownership

    - PATCH /documents/:id/validate (Admin)
      * Valider/rejeter document
      * body: { status: 'VALIDATED' | 'REJECTED', reason? }

[ ] Tests avec Postman (upload PDF, JPG, PNG)
```

#### T√¢ches Frontend

**Jour 5-6 : Composant DocumentUploader**
```typescript
[ ] Cr√©er components/forms/DocumentUploader.tsx :
    - Drag & drop zone (react-dropzone)
    - Preview des fichiers upload√©s
    - Progress bar pendant upload
    - Validation c√¥t√© client :
      * Types accept√©s : .pdf, .jpg, .jpeg, .png
      * Taille max : 5MB
    - Messages d'erreur clairs

[ ] Styling responsive
[ ] Tests upload divers fichiers
```

**Jour 7 : Int√©gration formulaire**
```typescript
[ ] Ajouter √©tape 4 optionnelle au formulaire claim :
    - "Documents justificatifs (optionnel)"
    - Upload carte d'embarquement
    - Upload autre document
    - Continuer sans document

[ ] Adapter ClaimForm pour g√©rer documents
[ ] Upload APR√àS cr√©ation claim (claim.id disponible)
```

**Jour 8 : Page Documents dans Dashboard**
```typescript
[ ] Cr√©er app/[locale]/dashboard/claims/[id]/documents/page.tsx
[ ] Afficher liste documents upload√©s :
    - Nom fichier
    - Type
    - Taille
    - Statut (Pending, Validated, Rejected)
    - Actions : Download, Delete

[ ] Bouton "Ajouter un document"
[ ] Empty state si aucun document
```

**Jour 9-10 : Admin - Validation Documents**
```typescript
[ ] Cr√©er app/[locale]/admin/documents/page.tsx
[ ] Liste documents √† valider :
    - Filtrer par statut PENDING
    - Afficher claim associ√©e
    - Preview dans modal (pour PDF/images)

[ ] Actions admin :
    - Valider (PATCH /documents/:id/validate)
    - Rejeter (avec raison)
    - Demander document manquant √† user

[ ] Tests validation flow complet
```

**Tests et Validation Semaine 11-12** :
- [ ] Upload de PDF, JPG, PNG fonctionne
- [ ] Preview dans admin
- [ ] Validation/rejet fonctionne
- [ ] Email notification envoy√©
- [ ] Download document fonctionne
- [ ] Suppression fonctionne

---

### SEMAINE 13-14 : API de Donn√©es de Vol

#### Objectif
Int√©grer API AviationStack pour v√©rifier automatiquement les vols et pr√©-remplir le formulaire.

#### T√¢ches Backend

**Jour 1 : Setup AviationStack**
```bash
[ ] Cr√©er compte AviationStack :
    https://aviationstack.com

[ ] Choisir plan :
    - Free : 100 req/mois (limit√© pour tester)
    - Basic : 10,000 req/mois, ~50‚Ç¨/mois

[ ] Obtenir API key
[ ] Ajouter dans .env :
    AVIATION_STACK_API_KEY=your_key_here
```

**Jour 2-3 : FlightDataModule**
```typescript
[ ] Cr√©er FlightDataModule
[ ] Cr√©er AviationStackAdapter :
    - searchFlights(query: string, date?: string)
      * Appelle GET /flights?search={query}&flight_date={date}
      * Parse r√©ponse
      * Normalise donn√©es

    - getFlightStatus(flightNumber: string, date: string)
      * Appelle GET /flights?flight_iata={flightNumber}&flight_date={date}
      * Retourne status, delays, airports, etc.

[ ] G√©rer erreurs API :
    - Rate limit exceeded
    - Invalid API key
    - Flight not found

[ ] Tests avec vrais num√©ros de vol
```

**Jour 4 : Cache Layer**
```typescript
[ ] Option A - node-cache (simple) :
    npm install node-cache
    const cache = new NodeCache({ stdTTL: 86400 }); // 24h

[ ] Option B - Redis (meilleur) :
    npm install @nestjs/cache-manager cache-manager
    npm install cache-manager-redis-store

[ ] Impl√©menter cache :
    - TTL 24h pour vols historiques
    - TTL 5min pour vols du jour
    - Cache key : `flight:${flightNumber}:${date}`

[ ] FlightDataService :
    - Wrapper qui check cache avant API call
    - Sauvegarde r√©sultat dans cache
```

**Jour 5 : FlightDataController**
```typescript
[ ] Cr√©er endpoints :
    - GET /flight-data/search?q={query}&date={YYYY-MM-DD}
      * Retourne liste vols correspondants
      * Pagination (10 r√©sultats)

    - GET /flight-data/validate?flight={XX1234}&date={YYYY-MM-DD}
      * V√©rifie qu'un vol existe
      * Retourne d√©tails complets si trouv√©
      * Cache la r√©ponse

[ ] Protection rate limiting (10 req/min/user)
[ ] Tests avec Postman
```

#### T√¢ches Frontend

**Jour 6-7 : Autocomplete Num√©ro de Vol**
```typescript
[ ] Cr√©er components/forms/FlightNumberInput.tsx :
    - Input avec autocomplete
    - Debounced search (500ms)
    - Appelle GET /flight-data/search
    - Affiche suggestions :
      * AF1234 - Paris CDG ‚Üí Tel Aviv TLV
      * Horaires pr√©vus
    - S√©lection ‚Üí pr√©-remplit departureAirport, arrivalAirport

[ ] Loading state pendant recherche
[ ] Gestion erreurs (aucun r√©sultat, API down)
```

**Jour 8 : Int√©gration Formulaire**
```typescript
[ ] Remplacer input flightNumber simple par FlightNumberInput
[ ] Quand vol s√©lectionn√© :
    - Appeler GET /flight-data/validate avec date
    - Pr√©-remplir departure et arrival
    - Pr√©-remplir airline
    - Si delay info disponible, pr√©-remplir delayMinutes

[ ] Utilisateur peut modifier valeurs si besoin
[ ] Validation que vol existe (optionnel)
```

**Jour 9-10 : Affichage Infos Vol**
```typescript
[ ] Cr√©er composant FlightInfoCard :
    - Affiche infos vol apr√®s autocomplete :
      * Compagnie + logo
      * Route compl√®te
      * Horaires pr√©vus
      * Horaires r√©els (si disponible)
      * Retard calcul√© automatiquement

[ ] Int√©grer dans formulaire (entre √©tape 1 et 2)
[ ] Design responsive
[ ] Tests avec plusieurs vols
```

**Tests et Validation Semaine 13-14** :
- [ ] Autocomplete fonctionne (vols r√©els)
- [ ] Cache √©vite appels API r√©p√©t√©s
- [ ] Pr√©-remplissage automatique fonctionne
- [ ] Calcul retard correct
- [ ] Utilisateur peut modifier si besoin
- [ ] Gestion erreurs API

---

### ‚úÖ SEMAINE 15-16 : Dashboard Admin Professionnel - COMPL√âT√â

#### Objectif ‚úÖ ATTEINT
Cr√©er un dashboard admin complet pour g√©rer efficacement toutes les r√©clamations.

#### T√¢ches Backend

**Jour 0 : User Roles & Authentication**
```typescript
[‚úÖ] Ajouter UserRole enum √† Prisma :
    - enum UserRole { USER, ADMIN }
    - User.role field avec default USER

[‚úÖ] Mise √† jour AuthService :
    - Include role dans JWT payload
    - Role-based authentication

[‚úÖ] Cr√©er AdminGuard :
    - V√©rifier role ADMIN
    - Protection endpoints admin

[‚úÖ] Migration database :
    - Ajouter colonne role
    - Set admin pour compte test (eliezelg@gmail.com)
```

**Jour 1 : API Stats**
```typescript
[‚úÖ] Cr√©er StatsService :
    - getOverviewStats()
      * Total claims
      * Claims pending review
      * Claims approved this month
      * Average claim amount

    - getClaimsByMonth() - 6 derniers mois
    - getClaimsByStatus() - Distribution
    - getTopAirlines() - Top 5

[‚úÖ] Cr√©er StatsController :
    - GET /admin/stats/overview
    - GET /admin/stats/claims-by-month
    - GET /admin/stats/claims-by-status
    - GET /admin/stats/top-airlines

[‚úÖ] Protection @UseGuards(JwtAuthGuard, AdminGuard)
```

**Jour 2 : API Admin Claims**
```typescript
[‚úÖ] Am√©liorer ClaimsController pour admin :
    - GET /admin/claims
      * Liste TOUTES les claims (tous users)
      * Pagination (page, limit)
      * Filtres (status)
      * Recherche (claim number, flight, email, name)
      * Includes user et flight info

    - PATCH /admin/claims/:id/status
      * Changer statut manuellement
      * body: { status }
      * Workflow validation

[ ] POST /admin/claims/:id/notes (Phase 3)
      * Ajouter note interne

[‚úÖ] Tests admin endpoints
```

#### T√¢ches Frontend Admin

**Jour 3-4 : Layout Admin**
```typescript
[‚úÖ] Cr√©er app/[locale]/admin/layout.tsx :
    - Sidebar navigation :
      * Dashboard (overview)
      * Claims Management
      * Documents (placeholder)
      * Users (placeholder)
      * Settings (placeholder)
      * Reports (placeholder)
    - Responsive (drawer sur mobile)
    - Support i18n avec next-intl

[‚úÖ] AdminSidebar component avec icons (Lucide)
[‚úÖ] Protection route (placeholder pour auth check)
[‚úÖ] Tests navigation
[‚úÖ] Fix Next.js 15 async params
```

**Jour 5-6 : Overview Page**
```typescript
[‚úÖ] Cr√©er app/[locale]/admin/page.tsx (dashboard)

[‚úÖ] Section Stats Cards :
    - Total Claims (all time)
    - Pending Review (count)
    - Approved This Month
    - Average Amount

[‚úÖ] Section Charts (Recharts) :
    - Line Chart : Claims par mois (6 derniers mois)
    - Pie Chart : Claims par statut
    - Bar Chart : Top 5 compagnies

[‚úÖ] Section R√©clamations R√©centes :
    - Table des r√©centes claims
    - Status badges
    - Liens vers d√©tails

[‚úÖ] Loading states et error handling
[‚úÖ] Responsive design
```

**Jour 7-8 : Claims Management Page**
```typescript
[‚úÖ] Cr√©er app/[locale]/admin/claims/page.tsx

[‚úÖ] Table compl√®te :
    - Colonnes :
      * Claim Number
      * Client (name + email)
      * Flight
      * Disruption Type (badge)
      * Status (badge)
      * Amount
      * Date
      * Actions (View)

[‚úÖ] Filtres :
    - Status (dropdown all/draft/submitted/in_review/etc.)
    - Search (claim number, flight, client name, email)

[‚úÖ] Export CSV :
    - Export des claims filtr√©es
    - Toutes les colonnes

[‚úÖ] Pagination : 10 items/page
[‚úÖ] Status badges avec couleurs
```

**Jour 9 : Claim Detail Admin**
```typescript
[‚úÖ] Cr√©er app/[locale]/admin/claims/[id]/page.tsx

[‚úÖ] Section Claim Info (read-only) :
    - Toutes les infos claim
    - Flight info avec icons
    - Passenger info
    - Compensation calculation

[‚úÖ] Section Quick Actions :
    - Change Status workflow :
      * DRAFT ‚Üí Submit for Review
      * SUBMITTED ‚Üí In Review
      * IN_REVIEW ‚Üí Approve / Reject
      * APPROVED ‚Üí Mark as Paid
    - Bouton "Change Status" avec confirmation

[‚úÖ] Section Documents :
    - Liste documents upload√©s
    - Liens de t√©l√©chargement

[‚úÖ] Section History :
    - Created timestamp
    - Submitted timestamp (if applicable)

[ ] Section Notes Internes (Phase 3)
    - Add/view internal notes
```

**Jour 10 : Users Management**
```typescript
[‚úÖ] Cr√©er app/[locale]/admin/users/page.tsx
[‚úÖ] Cr√©er AdminUsersController backend
[‚úÖ] GET /admin/users - Liste tous les users
[‚úÖ] GET /admin/users/stats - Statistiques users
[‚úÖ] Liste users avec 5 cartes de stats
[‚úÖ] Table compl√®te avec toutes les infos
[‚úÖ] Search par nom/email
[‚úÖ] Filtres par r√¥le (Client/Admin)
```

**Jour 11 : Statistics Page**
```typescript
[‚úÖ] Cr√©er app/[locale]/admin/statistics/page.tsx
[‚úÖ] 4 cartes m√©triques avec tendances
[‚úÖ] Filtre plage temporelle (6/12/24 mois)
[‚úÖ] Area Chart - Tendance des claims
[‚úÖ] 2 Pie Charts - Statuts et types de perturbation
[‚úÖ] Area Chart - Montants mensuels
[‚úÖ] Bar Chart - Top 10 airlines
[‚úÖ] Table d√©taill√©e types de perturbation
```

**Jour 12 : Settings Page**
```typescript
[‚úÖ] Cr√©er app/[locale]/admin/settings/page.tsx
[‚úÖ] Section Email Notifications (5 toggles)
[‚úÖ] Section System Configuration
[‚úÖ] Section Localization & Region
[‚úÖ] Section Compensation Limits
[‚úÖ] Section Database & Backup
[‚úÖ] Bouton Save Changes avec feedback
```

**Tests et Validation Semaine 15-16** :
- [‚úÖ] Dashboard overview affiche stats correctes
- [‚úÖ] Charts fonctionnent (responsive, Recharts)
- [‚úÖ] Claims management : filtres, recherche, pagination
- [‚úÖ] Change status fonctionne avec workflow
- [‚úÖ] Export CSV fonctionne
- [‚úÖ] Design professionnel avec Tailwind
- [‚úÖ] Support multilingue (admin namespace)
- [‚úÖ] Users management complet avec stats
- [‚úÖ] Statistics page avec charts avanc√©s
- [‚úÖ] Settings page avec configuration compl√®te
- [‚úÖ] Document download avec authentication
- [‚úÖ] Bouton d√©connexion dans sidebar
- [‚úÖ] Affichage vrai nom utilisateur
- [ ] Email notification lors changement status (report√© Phase 3)
- [ ] Notes internes (report√© Phase 3)

---

## üìä BILAN PHASE 2

### ‚úÖ R√©sultats Obtenus (Semaine 9-10, 15-16 COMPL√âT√âES)

**Technique** :
- ‚úÖ 3 langues compl√®tes (FR, HE, EN) avec next-intl
- ‚úÖ RTL parfait pour h√©breu
- ‚úÖ Upload documents fonctionnel (Fastify multipart)
- ‚úÖ Validation documents par admin
- ‚è≥ API de vol int√©gr√©e (Semaine 13-14 - √Ä FAIRE)
- ‚úÖ Dashboard admin professionnel COMPLET
- ‚úÖ 7 pages admin compl√®tes:
  * Dashboard avec stats et charts
  * Claims Management avec filtres
  * Claim Detail avec actions
  * Users Management avec stats
  * Documents Validation
  * Statistics avanc√©es
  * Settings complets

**Business** :
- üéØ 50-100 r√©clamations/mois
- üéØ Taux de compl√©tion formulaire > 80%
- üéØ Temps de traitement admin < 5 jours
- üéØ Satisfaction user sur multilingue

**Budget** :
```yaml
Infrastructure:
  - VPS Hetzner: 8-15‚Ç¨/mois
  - Cloudflare R2: 1‚Ç¨/mois
  - AviationStack: 50‚Ç¨/mois
  - Email Brevo: 15‚Ç¨/mois (si volume)

Total: ~75-80‚Ç¨/mois
```

---

## üéØ CRIT√àRES DE SUCC√àS PHASE 2

### Obligatoires
- [ ] 3 langues compl√®tes et sans bug
- [ ] RTL h√©breu parfait (aucun √©l√©ment mal align√©)
- [ ] Upload documents fonctionne (PDF + images)
- [ ] Admin peut valider/rejeter documents
- [ ] API de vol fonctionne avec cache
- [ ] Dashboard admin utilisable efficacement

### Optionnels (Phase 3 si manque de temps)
- [ ] Email multilingue (peut rester FR Phase 2)
- [ ] Export CSV avanc√©
- [ ] Graphiques anim√©s
- [ ] Dark mode admin

---

## üöÄ APR√àS PHASE 2 - PHASE 3

**Priorit√©s Phase 3** :
1. G√©n√©ration automatique de courriers PDF par compagnie
2. Am√©lioration dashboard admin (graphiques, rapports)
3. Syst√®me de notes et assignation d'agents
4. Messagerie int√©gr√©e (user ‚Üî admin)
5. Cache Redis pour performance
6. Monitoring et alertes

---

**Document cr√©√© le** : 26 Octobre 2025
**Version** : 1.0
**Dur√©e Phase 2** : 8 semaines
**Objectif** : Plateforme professionnelle multi-langue

**Pr√™t √† commencer Phase 2 ! üöÄ**
